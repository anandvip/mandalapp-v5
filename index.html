<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meditation Tracker</title>
  <style>
    /* Your CSS styles */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f4f4f4;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: #fff;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      display: grid;
      grid-template-columns: 1fr 3fr 1fr;
      gap: 20px;
    }
    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
      }
    }
    .dashboard, .mandala-info, .session-log, .meditation-notes {
      padding: 20px;
      background-color: #f9f9f9;
      border-radius: 5px;
    }
    .progress-bar {
      width: 100%;
      height: 20px;
      background-color: #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
    }
    #progressBar {
      height: 100%;
      background-color: #4CAF50;
      width: 0%;
      transition: width 0.5s ease;
    }
    .meditation-notes {
      background-color: #333;
      color: #fff;
      padding: 20px;
      border-radius: 5px;
      position: relative;
      height: fit-content;
    }
    .meditation-notes h2 {
      color: #fff;
    }
    .export-notes-btn {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 20px;
      position: fixed;
      bottom: 30px;
      right: 10px;
    }
    .note-card {
      padding: 10px;
      margin: 10px;
      background-color: #f9f9f9;
      border-radius: 5px;
    }
    .note-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
    }
    @media (max-width: 768px) {
      .note-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    .footer {
      margin-top: 20px;
      padding: 20px;
      background-color: #f9f9f9;
      border-radius: 5px;
      text-align: center;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    @media (max-width: 768px) {
      .footer {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
  <script src="https://unpkg.com/htmx.org@1.6.1"></script>
</head>
<body>
  <div class="container">
    <div class="dashboard">
      <h2>Dashboard</h2>
      <p>Today Date & Time: <span id="currentDateTime"></span></p>
      <p>Your Name: <span id="userName" contenteditable="true" onblur="saveUserName(event)">Vipul</span></p>
      <p>Mandal Name: <span id="mandalName" contenteditable="true" onblur="saveMandalName(event)">Bring Awareness to chit</span> <span class="info">â“˜</span></p>
      <p>Duration: <span id="duration">48 days</span></p>
      <p>Start Date: <input type="date" id="startDateInput" onchange="saveStartDate(event)" /></p>
      <p>End Date: <span id="endDate"></span></p>
      <p>Days Completed: <span id="daysCompleted">8</span></p>
      <p>Remaining Days: <span id="remainingDays">40</span></p>
      <p>Sessions Completed: <span id="sessionsCompleted">20 / 96</span></p>
      <p>Mandal Completed: <span id="mandalsCompleted" contenteditable="true" onblur="saveMandalsCompleted(event)">5</span></p>
      <button onclick="createSession()">Create Session</button>
      <button onclick="deleteMandal()">Delete Mandal</button>
    </div>
    <div>
      <h1>Meditation Tracker</h1>
      <div class="mandala-info">
        <h2 id="mandalaNameHeader"></h2>
        <p>Observer: <span id="observerName"></span></p>
        <p>Start Date: <span id="startDate"></span></p>
        <p>End Date: <span id="endDateHeader"></span></p>
        <p>Sessions Completed: <span id="sessionsCompletedHeader"></span> / <span id="totalSessions"></span></p>
        <div class="progress-bar">
          <div id="progressBar"></div>
        </div>
      </div>
      <div class="session-log">
        <h2>Your Meditation History</h2>
        <div id="sessionLog"></div>
      </div>
    </div>
    <div class="meditation-notes">
      <h2>Meditation Notes</h2>
      <div id="notesSection"></div>
      <button class="export-notes-btn" onclick="exportNotes()">Export Notes</button>
    </div>
  </div>
  <script>
    const masterKey = 'mandalProgressLatest';

    function getMasterObject() {
      const storedMasterObject = localStorage.getItem(masterKey);
      return storedMasterObject ? JSON.parse(storedMasterObject) : null;
    }

    function saveMasterObject(masterObject) {
      localStorage.setItem(masterKey, JSON.stringify(masterObject));
    }

    function saveUserName(event) {
      const masterObject = getMasterObject();
      if (masterObject) {
        masterObject.userName = event.target.textContent.trim();
        saveMasterObject(masterObject);
        updateDashboard();
      }
    }

    function saveMandalName(event) {
      const masterObject = getMasterObject();
      if (masterObject) {
        masterObject.mandalName = event.target.textContent.trim();
        saveMasterObject(masterObject);
        updateDashboard();
      }
    }

    function saveStartDate(event) {
      const masterObject = getMasterObject();
      if (masterObject) {
        masterObject.startDate = event.target.value;
        const endDate = new Date(event.target.value);
        endDate.setDate(endDate.getDate() + masterObject.duration);
        masterObject.endDate = endDate.toDateString();
        saveMasterObject(masterObject);
        updateDashboard();
      }
    }

    function saveMandalsCompleted(event) {
      const masterObject = getMasterObject();
      if (masterObject) {
        masterObject.mandalsCompleted = parseInt(event.target.textContent.trim());
        saveMasterObject(masterObject);
        updateDashboard();
      }
    }

    function updateDashboard() {
      const masterObject = getMasterObject();
      if (masterObject) {
        document.getElementById('currentDateTime').textContent = new Date().toLocaleString();
        document.getElementById('userName').textContent = masterObject.userName;
        document.getElementById('mandalName').textContent = masterObject.mandalName;
        document.getElementById('mandalNameHeader').textContent = masterObject.mandalName;
        document.getElementById('observerName').textContent = masterObject.userName;
        document.getElementById('startDate').textContent = masterObject.startDate;
        document.getElementById('endDate').textContent = masterObject.endDate;
        document.getElementById('endDateHeader').textContent = masterObject.endDate;
        document.getElementById('daysCompleted').textContent = masterObject.daysCompleted;
        document.getElementById('remainingDays').textContent = masterObject.duration - masterObject.daysCompleted;
        document.getElementById('sessionsCompleted').textContent = masterObject.sessionsCompleted + ' / ' + masterObject.totalSessions;
        document.getElementById('mandalsCompleted').textContent = masterObject.mandalsCompleted;
        document.getElementById('sessionsCompletedHeader').textContent = masterObject.sessionsCompleted;
        document.getElementById('totalSessions').textContent = masterObject.totalSessions;

        const progress = (masterObject.sessionsCompleted / masterObject.totalSessions) * 100;
        document.getElementById('progressBar').style.width = `${progress}%`;
      }
    }

    function createSession() {
      // Logic for creating a session
    }

    function deleteMandal() {
      localStorage.removeItem(masterKey);
      location.reload();
    }

    function saveSessionNotes(event) {
      const masterObject = getMasterObject();
      if (masterObject) {
        const index = event.target.dataset.index;
        const newNotes = event.target.textContent.trim();

        masterObject.sessions[index].notes = newNotes;
        saveMasterObject(masterObject);
        updateMeditationNotes();
      }
    }

    function updateMeditationNotes() {
      const masterObject = getMasterObject();
      if (masterObject) {
        const notesSectionElement = document.getElementById('notesSection');
        notesSectionElement.innerHTML = '';

        let day = 1;
        for (let i = 0; i < masterObject.sessions.length; i += 2) {
          const morningSession = masterObject.sessions[i];
          const eveningSession = masterObject.sessions[i + 1];

          if (morningSession && morningSession.notes) {
            const morningNoteCard = document.createElement('div');
            morningNoteCard.classList.add('note-card');

            const morningNoteContent = document.createElement('p');
            morningNoteContent.innerHTML = `Day ${day} Morning (${morningSession.date}): ${morningSession.notes}`;
            morningNoteContent.setAttribute('contenteditable', 'true');
            morningNoteContent.dataset.index = i;
            morningNoteContent.setAttribute('onblur', 'saveSessionNotes(event)');
            morningNoteCard.appendChild(morningNoteContent);

            notesSectionElement.appendChild(morningNoteCard);
          }

          if (eveningSession && eveningSession.notes) {
            const eveningNoteCard = document.createElement('div');
            eveningNoteCard.classList.add('note-card');

            const eveningNoteContent = document.createElement('p');
            eveningNoteContent.innerHTML = `Day ${day} Evening (${eveningSession.date}): ${eveningSession.notes}`;
            eveningNoteContent.setAttribute('contenteditable', 'true');
            eveningNoteContent.dataset.index = i + 1;
            eveningNoteContent.setAttribute('onblur', 'saveSessionNotes(event)');
            eveningNoteCard.appendChild(eveningNoteContent);

            notesSectionElement.appendChild(eveningNoteCard);
          }

          day++;
        }
      }
    }

    function exportNotes() {
      const masterObject = getMasterObject();
      if (masterObject) {
        let exportHTML = `
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Meditation Notes Export</title>
            <style>
              body {
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 20px;
                background-color: #f4f4f4;
              }
              .container {
                max-width: 1000px;
                margin: 0 auto;
                background-color: #fff;
                padding: 20px;
                border-radius: 5px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
              }
              .header {
                position: relative;
                margin-bottom: 20px;
                text-align: center;
                background-image: url('https://github.com/anandvip/kali-yuga/blob/main/thoughts.png?raw=true');
                background-size: cover;
                background-position: center;
                width: 100%;
                height: 500px;
                border-radius: 20px;
                overflow: hidden;
              }
              .header h1 {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                color: white;
                font-size: 2.5em;
                margin: 0;
              }
              .note-card {
                padding: 10px;
                margin: 10px;
                background-color: #f9f9f9;
                border-radius: 5px;
              }
              .note-grid {
                display: grid;
                grid-template-columns: repeat(5, 1fr);
                gap: 10px;
              }
              .footer {
                margin-top: 20px;
                padding: 20px;
                background-color: #f9f9f9;
                border-radius: 5px;
                text-align: center;
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
              }
              @media (max-width: 768px) {
                .note-grid {
                  grid-template-columns: repeat(2, 1fr);
                }
                .footer {
                  grid-template-columns: repeat(2, 1fr);
                }
              }
            </style>
          </head>
          <body>
            <div class="container">
              <div class="header">
                <h1>${masterObject.mandalName}</h1>
              </div>
              <div class="note-grid">`;

        masterObject.sessions.forEach((session, index) => {
          if (session.notes && session.notes.trim() !== "") {
            exportHTML += `
              <div class="note-card">
                <p>Day ${Math.floor(index / 2) + 1} ${index % 2 === 0 ? 'Morning' : 'Evening'} (${session.date}): ${session.notes}</p>
                <p>Date: ${session.date} | Time: ${session.startTime} - ${session.endTime}</p>
                <p>Observer: ${masterObject.userName}</p>
              </div>`;
          }
        });

        exportHTML += `
              </div>
              <div class="footer">
                <p>Duration: ${masterObject.startDate} to ${masterObject.endDate}</p>
                <p>Exported on: ${new Date().toLocaleDateString()}</p>
                <p>Observations captured by: ${masterObject.userName}</p>
              </div>
            </div>
          </body>
        </html>`;

        const blob = new Blob([exportHTML], { type: 'text/html' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'meditation_notes.html';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
                document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    }

    function checkForExistingMandal() {
      const masterObject = getMasterObject();
      if (masterObject) {
        const endDate = new Date(masterObject.endDate);
        const currentDate = new Date();
        if (endDate < currentDate) {
          // Show intrusive toast
          const toast = document.createElement('div');
          toast.style.position = 'fixed';
          toast.style.top = '50%';
          toast.style.left = '50%';
          toast.style.transform = 'translate(-50%, -50%)';
          toast.style.backgroundColor = 'black';
          toast.style.color = 'aqua';
          toast.style.padding = '20px';
          toast.style.borderRadius = '5px';
          toast.style.zIndex = '1000';
          toast.innerHTML = `
            <p>The existing Mandal has ended. Do you want to mark it as complete?</p>
            <button onclick="markMandalComplete()">Yes</button>
            <button onclick="closeToast()">Cancel</button>
          `;
          document.body.appendChild(toast);
        }
      }
    }

    function markMandalComplete() {
      const masterObject = getMasterObject();
      if (masterObject) {
        let completedMandals = localStorage.getItem('completedMandals');
        completedMandals = completedMandals ? JSON.parse(completedMandals) : [];
        completedMandals.push(masterObject);
        localStorage.setItem('completedMandals', JSON.stringify(completedMandals));
        localStorage.removeItem(masterKey);
        location.reload();
      }
    }

    function closeToast() {
      const toast = document.querySelector('div[style*="position: fixed"]');
      if (toast) {
        toast.remove();
      }
    }

    // Initial setup
    document.addEventListener('DOMContentLoaded', () => {
      checkForExistingMandal();
      updateDashboard();
      displaySessionLog();
      updateMeditationNotes();
    });

    // Function to create session
    function createSession() {
      const masterObject = getMasterObject();
      if (masterObject) {
        if (!masterObject.sessions) {
          masterObject.sessions = [];
        }
        const currentDate = new Date();
        const session = {
          date: currentDate.toDateString(),
          startTime: `${currentDate.getHours()}:${currentDate.getMinutes()}:${currentDate.getSeconds()}`,
          endTime: '',
          completed: false,
          notes: ''
        };
        masterObject.sessions.push(session);
        saveMasterObject(masterObject);
        displaySessionLog();
        updateMeditationNotes();
      }
    }

    // Function to end session
    function endSession(index) {
      const masterObject = getMasterObject();
      if (masterObject && masterObject.sessions[index]) {
        const currentDate = new Date();
        masterObject.sessions[index].endTime = `${currentDate.getHours()}:${currentDate.getMinutes()}:${currentDate.getSeconds()}`;
        masterObject.sessions[index].completed = true;
        saveMasterObject(masterObject);
        displaySessionLog();
        updateMeditationNotes();
      }
    }
  </script>
</body>
</html>

     
